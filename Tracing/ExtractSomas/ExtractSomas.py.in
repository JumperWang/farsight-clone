#!/usr/bin/env python

import os
import os.path
import subprocess
import sys

scriptPath = os.path.dirname(sys.argv[0])
if scriptPath != "":
  os.chdir(scriptPath)

if len(sys.argv) < 3:
  print sys.argv[0] + " <input image> <output image>"
  sys.exit(1)

input = sys.argv[1]
output = sys.argv[2] 

outputDir = os.path.dirname(output)

subprocess.call([
  "./${CMAKE_CFG_INTDIR}/MedianImageFilter${CMAKE_EXECUTABLE_SUFFIX}",
  input, outputDir + "/median.tif"])
subprocess.call([
  "./${CMAKE_CFG_INTDIR}/RobustAutomaticThresholdImageFilterTest${CMAKE_EXECUTABLE_SUFFIX}",
  outputDir + "/median.tif", outputDir + "/robust.tif", "2", "2.0"])
subprocess.call([
  "./${CMAKE_CFG_INTDIR}/PadImage${CMAKE_EXECUTABLE_SUFFIX}",
  outputDir + "/robust.tif", outputDir + "/padded.tif"])
subprocess.call([
  "./${CMAKE_CFG_INTDIR}/HoleFillingFilterTest${CMAKE_EXECUTABLE_SUFFIX}",
  outputDir + "/padded.tif", outputDir + "/filled_padded.tif", "1000", "1"])
subprocess.call([
  "./${CMAKE_CFG_INTDIR}/ExtractImageFromPadding${CMAKE_EXECUTABLE_SUFFIX}",
  outputDir + "/filled_padded.tif", outputDir + "/filled.tif"])
subprocess.call([
  "./${CMAKE_CFG_INTDIR}/DistanceMapFilter${CMAKE_EXECUTABLE_SUFFIX}",
  outputDir + "/filled.tif", outputDir + "/distance.mhd"])
#somas get bigger as the last parameter to BinaryThresholdImageFilter gets smaller
subprocess.call([
  "./${CMAKE_CFG_INTDIR}/BinaryThresholdImageFilter${CMAKE_EXECUTABLE_SUFFIX}",
  outputDir + "/distance.mhd", outputDir + "/distanceThreshold.tif", "1.0"])
subprocess.call([
  "./${CMAKE_CFG_INTDIR}/PadImage${CMAKE_EXECUTABLE_SUFFIX}",
  outputDir + "/distanceThreshold.tif",
  outputDir + "/distanceThreshold_padded.tif"])
subprocess.call([
  "./${CMAKE_CFG_INTDIR}/PadDistanceMap${CMAKE_EXECUTABLE_SUFFIX}",
  outputDir + "/distance.mhd", outputDir + "/distance_padded.mhd"])
#last parameter of DownwardFrontPropagation should be expected radius of tubes
subprocess.call([
  "./${CMAKE_CFG_INTDIR}/DownwardFrontPropagation${CMAKE_EXECUTABLE_SUFFIX}",
  outputDir + "/distanceThreshold_padded.tif",
  outputDir + "/distance_padded.mhd", outputDir + "/output_somas_padded.tif",
  "1000", "1.0"])
subprocess.call([
  "./${CMAKE_CFG_INTDIR}/ExtractImageFromPadding${CMAKE_EXECUTABLE_SUFFIX}",
  outputDir + "/output_somas_padded.tif", output])
subprocess.call([
  "./${CMAKE_CFG_INTDIR}/IsolateCentroids${CMAKE_EXECUTABLE_SUFFIX}",
  output, outputDir + "/centroids.tif", outputDir + "/soma-centroids.txt"])
